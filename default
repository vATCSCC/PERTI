server {
    listen 8080;
    listen [::]:8080;
    root /home/site/wwwroot;
    index index.php index.html;
    server_name _;
    port_in_redirect off;

    # Handle /login directory
    location = /login {
        rewrite ^/login/?$ /login/index.php last;
    }

    # Main location block - try file, then .php, then 404
    location / {
        try_files $uri $uri/ $uri.php?$query_string @php;
    }

    # Fallback to PHP handler
    location @php {
        rewrite ^(.*)$ $1.php last;
    }

    # PHP-FPM handler
    location ~ \.php$ {
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        fastcgi_pass 127.0.0.1:9000;
        fastcgi_index index.php;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param PATH_INFO $fastcgi_path_info;
        fastcgi_param HTTPS on;
        fastcgi_read_timeout 300;
    }

    # WebSocket proxy for SWIM API
    location /api/swim/v1/ws {
        proxy_pass http://127.0.0.1:8090;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_read_timeout 3600s;
    }

    # Deny access to hidden files
    location ~ /\. {
        deny all;
    }
}
