name: PERTI Site Monitor

# External monitoring that runs on GitHub's infrastructure
# Completely independent of Azure - will alert even if Azure is down

on:
  # Run every 5 minutes
  schedule:
    - cron: '*/5 * * * *'

  # Allow manual trigger for testing
  workflow_dispatch:
    inputs:
      force_alert:
        description: 'Send test alert to Discord'
        required: false
        default: 'false'
        type: boolean

env:
  SITE_URL: 'https://vatcscc.azurewebsites.net'
  # Timeout for each request in seconds
  REQUEST_TIMEOUT: 30

jobs:
  monitor:
    runs-on: ubuntu-latest

    steps:
    - name: Get timestamp
      id: time
      run: echo "timestamp=$(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT

    # Test 1: Homepage loads
    - name: Check Homepage
      id: homepage
      continue-on-error: true
      run: |
        echo "=== Testing Homepage ==="
        START=$(date +%s%N)

        RESPONSE=$(curl -sS -w "\n%{http_code}\n%{time_total}" \
          --max-time ${{ env.REQUEST_TIMEOUT }} \
          -o /tmp/homepage.html \
          "${{ env.SITE_URL }}/" 2>&1) || true

        END=$(date +%s%N)

        # Parse response
        HTTP_CODE=$(echo "$RESPONSE" | tail -2 | head -1)
        TIME_TOTAL=$(echo "$RESPONSE" | tail -1)

        echo "http_code=$HTTP_CODE" >> $GITHUB_OUTPUT
        echo "response_time=$TIME_TOTAL" >> $GITHUB_OUTPUT

        # Check for success
        if [[ "$HTTP_CODE" =~ ^2[0-9][0-9]$ ]]; then
          echo "status=ok" >> $GITHUB_OUTPUT
          echo "Homepage OK (HTTP $HTTP_CODE, ${TIME_TOTAL}s)"
        else
          echo "status=fail" >> $GITHUB_OUTPUT
          echo "Homepage FAILED (HTTP $HTTP_CODE)"
          # Capture first 500 chars of response for diagnostics
          echo "Response preview:"
          head -c 500 /tmp/homepage.html || echo "(empty response)"
        fi

    # Test 2: Public API - Flight Stats (tests database connectivity)
    - name: Check Flight Stats API
      id: stats_api
      continue-on-error: true
      run: |
        echo "=== Testing Flight Stats API ==="
        START=$(date +%s%N)

        RESPONSE=$(curl -sS -w "\n%{http_code}\n%{time_total}" \
          --max-time ${{ env.REQUEST_TIMEOUT }} \
          -H "Accept: application/json" \
          -o /tmp/stats.json \
          "${{ env.SITE_URL }}/api/adl/stats.php" 2>&1) || true

        HTTP_CODE=$(echo "$RESPONSE" | tail -2 | head -1)
        TIME_TOTAL=$(echo "$RESPONSE" | tail -1)

        echo "http_code=$HTTP_CODE" >> $GITHUB_OUTPUT
        echo "response_time=$TIME_TOTAL" >> $GITHUB_OUTPUT

        if [[ "$HTTP_CODE" =~ ^2[0-9][0-9]$ ]]; then
          # Validate JSON response
          if jq -e . /tmp/stats.json > /dev/null 2>&1; then
            FLIGHT_COUNT=$(jq -r '.total // .count // "unknown"' /tmp/stats.json 2>/dev/null || echo "unknown")
            echo "status=ok" >> $GITHUB_OUTPUT
            echo "flight_count=$FLIGHT_COUNT" >> $GITHUB_OUTPUT
            echo "Stats API OK (HTTP $HTTP_CODE, ${TIME_TOTAL}s, flights: $FLIGHT_COUNT)"
          else
            echo "status=fail" >> $GITHUB_OUTPUT
            echo "Stats API returned invalid JSON (HTTP $HTTP_CODE)"
            echo "Response:"
            cat /tmp/stats.json | head -c 500
          fi
        else
          echo "status=fail" >> $GITHUB_OUTPUT
          echo "Stats API FAILED (HTTP $HTTP_CODE)"
          cat /tmp/stats.json | head -c 500 || echo "(empty response)"
        fi

    # Test 3: JATOC Public Page (no auth required)
    - name: Check JATOC Page
      id: jatoc
      continue-on-error: true
      run: |
        echo "=== Testing JATOC Page ==="

        RESPONSE=$(curl -sS -w "\n%{http_code}\n%{time_total}" \
          --max-time ${{ env.REQUEST_TIMEOUT }} \
          -o /tmp/jatoc.html \
          "${{ env.SITE_URL }}/jatoc.php" 2>&1) || true

        HTTP_CODE=$(echo "$RESPONSE" | tail -2 | head -1)
        TIME_TOTAL=$(echo "$RESPONSE" | tail -1)

        echo "http_code=$HTTP_CODE" >> $GITHUB_OUTPUT
        echo "response_time=$TIME_TOTAL" >> $GITHUB_OUTPUT

        if [[ "$HTTP_CODE" =~ ^2[0-9][0-9]$ ]]; then
          echo "status=ok" >> $GITHUB_OUTPUT
          echo "JATOC OK (HTTP $HTTP_CODE, ${TIME_TOTAL}s)"
        else
          echo "status=fail" >> $GITHUB_OUTPUT
          echo "JATOC FAILED (HTTP $HTTP_CODE)"
        fi

    # Test 4: NOD Public Page
    - name: Check NOD Page
      id: nod
      continue-on-error: true
      run: |
        echo "=== Testing NOD Page ==="

        RESPONSE=$(curl -sS -w "\n%{http_code}\n%{time_total}" \
          --max-time ${{ env.REQUEST_TIMEOUT }} \
          -o /tmp/nod.html \
          "${{ env.SITE_URL }}/nod.php" 2>&1) || true

        HTTP_CODE=$(echo "$RESPONSE" | tail -2 | head -1)
        TIME_TOTAL=$(echo "$RESPONSE" | tail -1)

        echo "http_code=$HTTP_CODE" >> $GITHUB_OUTPUT
        echo "response_time=$TIME_TOTAL" >> $GITHUB_OUTPUT

        if [[ "$HTTP_CODE" =~ ^2[0-9][0-9]$ ]]; then
          echo "status=ok" >> $GITHUB_OUTPUT
          echo "NOD OK (HTTP $HTTP_CODE, ${TIME_TOTAL}s)"
        else
          echo "status=fail" >> $GITHUB_OUTPUT
          echo "NOD FAILED (HTTP $HTTP_CODE)"
        fi

    # Test 5: Active Flights API (tests real-time data pipeline)
    - name: Check Active Flights API
      id: flights_api
      continue-on-error: true
      run: |
        echo "=== Testing Active Flights API ==="

        RESPONSE=$(curl -sS -w "\n%{http_code}\n%{time_total}" \
          --max-time ${{ env.REQUEST_TIMEOUT }} \
          -H "Accept: application/json" \
          -o /tmp/flights.json \
          "${{ env.SITE_URL }}/api/adl/current.php?limit=1" 2>&1) || true

        HTTP_CODE=$(echo "$RESPONSE" | tail -2 | head -1)
        TIME_TOTAL=$(echo "$RESPONSE" | tail -1)

        echo "http_code=$HTTP_CODE" >> $GITHUB_OUTPUT
        echo "response_time=$TIME_TOTAL" >> $GITHUB_OUTPUT

        if [[ "$HTTP_CODE" =~ ^2[0-9][0-9]$ ]]; then
          if jq -e . /tmp/flights.json > /dev/null 2>&1; then
            echo "status=ok" >> $GITHUB_OUTPUT
            echo "Active Flights API OK (HTTP $HTTP_CODE, ${TIME_TOTAL}s)"
          else
            echo "status=fail" >> $GITHUB_OUTPUT
            echo "Active Flights API returned invalid JSON"
          fi
        else
          echo "status=fail" >> $GITHUB_OUTPUT
          echo "Active Flights API FAILED (HTTP $HTTP_CODE)"
        fi

    # Analyze results and determine overall status
    - name: Analyze Results
      id: analyze
      run: |
        echo "=== MONITORING SUMMARY ==="
        echo "Timestamp: ${{ steps.time.outputs.timestamp }}"
        echo ""

        FAILURES=0
        DETAILS=""

        # Check each endpoint
        if [[ "${{ steps.homepage.outputs.status }}" != "ok" ]]; then
          FAILURES=$((FAILURES + 1))
          DETAILS="${DETAILS}Homepage: FAIL (HTTP ${{ steps.homepage.outputs.http_code }})\n"
        else
          DETAILS="${DETAILS}Homepage: OK (${{ steps.homepage.outputs.response_time }}s)\n"
        fi

        if [[ "${{ steps.stats_api.outputs.status }}" != "ok" ]]; then
          FAILURES=$((FAILURES + 1))
          DETAILS="${DETAILS}Stats API: FAIL (HTTP ${{ steps.stats_api.outputs.http_code }})\n"
        else
          DETAILS="${DETAILS}Stats API: OK (${{ steps.stats_api.outputs.response_time }}s)\n"
        fi

        if [[ "${{ steps.jatoc.outputs.status }}" != "ok" ]]; then
          FAILURES=$((FAILURES + 1))
          DETAILS="${DETAILS}JATOC: FAIL (HTTP ${{ steps.jatoc.outputs.http_code }})\n"
        else
          DETAILS="${DETAILS}JATOC: OK (${{ steps.jatoc.outputs.response_time }}s)\n"
        fi

        if [[ "${{ steps.nod.outputs.status }}" != "ok" ]]; then
          FAILURES=$((FAILURES + 1))
          DETAILS="${DETAILS}NOD: FAIL (HTTP ${{ steps.nod.outputs.http_code }})\n"
        else
          DETAILS="${DETAILS}NOD: OK (${{ steps.nod.outputs.response_time }}s)\n"
        fi

        if [[ "${{ steps.flights_api.outputs.status }}" != "ok" ]]; then
          FAILURES=$((FAILURES + 1))
          DETAILS="${DETAILS}Flights API: FAIL (HTTP ${{ steps.flights_api.outputs.http_code }})\n"
        else
          DETAILS="${DETAILS}Flights API: OK (${{ steps.flights_api.outputs.response_time }}s)\n"
        fi

        echo -e "$DETAILS"
        echo ""
        echo "Total failures: $FAILURES"

        # Set outputs
        echo "failures=$FAILURES" >> $GITHUB_OUTPUT
        echo "details<<EOF" >> $GITHUB_OUTPUT
        echo -e "$DETAILS" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

        if [[ $FAILURES -gt 0 ]]; then
          echo "overall_status=DEGRADED" >> $GITHUB_OUTPUT
        else
          echo "overall_status=HEALTHY" >> $GITHUB_OUTPUT
        fi

    # Send Discord alert if there are failures
    - name: Send Discord Alert
      if: steps.analyze.outputs.failures != '0' || github.event.inputs.force_alert == 'true'
      env:
        DISCORD_WEBHOOK: ${{ secrets.MONITORING_DISCORD_WEBHOOK }}
      run: |
        if [[ -z "$DISCORD_WEBHOOK" ]]; then
          echo "Warning: MONITORING_DISCORD_WEBHOOK secret not set - skipping Discord alert"
          exit 0
        fi

        FAILURES="${{ steps.analyze.outputs.failures }}"
        TIMESTAMP="${{ steps.time.outputs.timestamp }}"

        # Determine severity color
        if [[ "$FAILURES" -ge 3 ]]; then
          COLOR=15158332  # Red - critical
          SEVERITY="CRITICAL"
        elif [[ "$FAILURES" -ge 1 ]]; then
          COLOR=15105570  # Orange - warning
          SEVERITY="WARNING"
        else
          COLOR=3066993   # Green - test alert
          SEVERITY="TEST"
        fi

        # Build embed fields
        FIELDS='['

        # Homepage
        if [[ "${{ steps.homepage.outputs.status }}" == "ok" ]]; then
          FIELDS="${FIELDS}{\"name\":\"Homepage\",\"value\":\"OK (${{ steps.homepage.outputs.response_time }}s)\",\"inline\":true},"
        else
          FIELDS="${FIELDS}{\"name\":\"Homepage\",\"value\":\"FAIL (HTTP ${{ steps.homepage.outputs.http_code }})\",\"inline\":true},"
        fi

        # Stats API
        if [[ "${{ steps.stats_api.outputs.status }}" == "ok" ]]; then
          FIELDS="${FIELDS}{\"name\":\"Stats API\",\"value\":\"OK (${{ steps.stats_api.outputs.response_time }}s)\",\"inline\":true},"
        else
          FIELDS="${FIELDS}{\"name\":\"Stats API\",\"value\":\"FAIL (HTTP ${{ steps.stats_api.outputs.http_code }})\",\"inline\":true},"
        fi

        # JATOC
        if [[ "${{ steps.jatoc.outputs.status }}" == "ok" ]]; then
          FIELDS="${FIELDS}{\"name\":\"JATOC\",\"value\":\"OK (${{ steps.jatoc.outputs.response_time }}s)\",\"inline\":true},"
        else
          FIELDS="${FIELDS}{\"name\":\"JATOC\",\"value\":\"FAIL (HTTP ${{ steps.jatoc.outputs.http_code }})\",\"inline\":true},"
        fi

        # NOD
        if [[ "${{ steps.nod.outputs.status }}" == "ok" ]]; then
          FIELDS="${FIELDS}{\"name\":\"NOD\",\"value\":\"OK (${{ steps.nod.outputs.response_time }}s)\",\"inline\":true},"
        else
          FIELDS="${FIELDS}{\"name\":\"NOD\",\"value\":\"FAIL (HTTP ${{ steps.nod.outputs.http_code }})\",\"inline\":true},"
        fi

        # Flights API
        if [[ "${{ steps.flights_api.outputs.status }}" == "ok" ]]; then
          FIELDS="${FIELDS}{\"name\":\"Flights API\",\"value\":\"OK (${{ steps.flights_api.outputs.response_time }}s)\",\"inline\":true},"
        else
          FIELDS="${FIELDS}{\"name\":\"Flights API\",\"value\":\"FAIL (HTTP ${{ steps.flights_api.outputs.http_code }})\",\"inline\":true},"
        fi

        # Add workflow link field
        FIELDS="${FIELDS}{\"name\":\"Details\",\"value\":\"[View workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\",\"inline\":false}"

        FIELDS="${FIELDS}]"

        # Build the payload
        PAYLOAD=$(cat <<EOF
        {
          "content": null,
          "embeds": [{
            "title": "PERTI Site Monitor - ${SEVERITY}",
            "description": "**${FAILURES} endpoint(s) failing**\nSite: ${{ env.SITE_URL }}",
            "color": ${COLOR},
            "fields": ${FIELDS},
            "footer": {
              "text": "PERTI External Monitor"
            },
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }]
        }
        EOF
        )

        # Send to Discord
        curl -sS -X POST \
          -H "Content-Type: application/json" \
          -d "$PAYLOAD" \
          "$DISCORD_WEBHOOK"

        echo "Discord alert sent"

    # Optional: Send recovery notification when site comes back up
    # This requires caching the previous state

    # Fail the workflow if there are critical failures (all endpoints down)
    - name: Check for Critical Failure
      if: steps.analyze.outputs.failures >= 4
      run: |
        echo "CRITICAL: Multiple endpoints are down!"
        echo "This will show as a failed workflow in GitHub Actions"
        exit 1
