# SWIM WebSocket Proxy Configuration
# Location: /home/site/apache/websocket.conf
# 
# This config proxies WebSocket connections from external clients
# to the internal Ratchet WebSocket server on port 8090.
#
# Include this in your Apache config or .htaccess

# Enable required modules (already enabled on Azure App Service)
# LoadModule proxy_module modules/mod_proxy.so
# LoadModule proxy_http_module modules/mod_proxy_http.so
# LoadModule proxy_wstunnel_module modules/mod_proxy_wstunnel.so
# LoadModule rewrite_module modules/mod_rewrite.so

<IfModule mod_proxy.c>
    # Enable proxying
    ProxyRequests Off
    ProxyPreserveHost On

    # WebSocket proxy for SWIM API
    # Route: wss://perti.vatcscc.org/api/swim/v1/ws -> ws://localhost:8090
    
    <Location /api/swim/v1/ws>
        # Required for WebSocket upgrade
        RewriteEngine On
        
        # Check for WebSocket upgrade request
        RewriteCond %{HTTP:Upgrade} websocket [NC]
        RewriteCond %{HTTP:Connection} upgrade [NC]
        
        # Proxy to internal WebSocket server
        RewriteRule ^(.*)$ ws://127.0.0.1:8090/$1 [P,L]
        
        # Fallback for non-WebSocket requests (return error)
        RewriteRule ^(.*)$ - [F,L]
        
        # Proxy settings
        ProxyPass ws://127.0.0.1:8090/
        ProxyPassReverse ws://127.0.0.1:8090/
        
        # Timeout settings for long-lived connections
        ProxyTimeout 3600
    </Location>

    # Alternative simpler config if the above doesn't work
    # ProxyPass /api/swim/v1/ws ws://127.0.0.1:8090/
    # ProxyPassReverse /api/swim/v1/ws ws://127.0.0.1:8090/
</IfModule>
