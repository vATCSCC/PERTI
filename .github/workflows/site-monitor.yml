name: PERTI Site Monitor

on:
  schedule:
    - cron: '* * * * *'  # Every minute (closest to 90s GitHub supports)

  workflow_dispatch:
    inputs:
      force_alert:
        description: 'Send test alert to Discord'
        required: false
        default: false
        type: boolean

env:
  SITE_URL: 'https://perti.vatcscc.org'
  REQUEST_TIMEOUT: 30

jobs:
  monitor:
    runs-on: ubuntu-latest

    steps:
    - name: Get timestamp
      id: time
      run: echo "timestamp=$(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT

    - name: Check Homepage
      id: homepage
      continue-on-error: true
      run: |
        RESPONSE=$(curl -sS -w "\n%{http_code}|%{time_namelookup}|%{time_connect}|%{time_starttransfer}|%{time_total}|%{size_download}" \
          --max-time ${{ env.REQUEST_TIMEOUT }} \
          -o /tmp/homepage.html \
          "${{ env.SITE_URL }}/" 2>&1) || true
        IFS='|' read -r HTTP_CODE DNS CONNECT TTFB TOTAL SIZE <<< "$(echo "$RESPONSE" | tail -1)"
        echo "http_code=$HTTP_CODE" >> $GITHUB_OUTPUT
        echo "ttfb=${TTFB}s" >> $GITHUB_OUTPUT
        echo "total=${TOTAL}s" >> $GITHUB_OUTPUT
        if [[ "$HTTP_CODE" =~ ^2[0-9][0-9]$ ]]; then
          echo "status=ok" >> $GITHUB_OUTPUT
        else
          echo "status=fail" >> $GITHUB_OUTPUT
          echo "error=$(head -c 200 /tmp/homepage.html 2>/dev/null | tr '\n' ' ')" >> $GITHUB_OUTPUT
        fi

    - name: Check JATOC
      id: jatoc
      continue-on-error: true
      run: |
        RESPONSE=$(curl -sS -w "\n%{http_code}|%{time_starttransfer}|%{time_total}" \
          --max-time ${{ env.REQUEST_TIMEOUT }} -o /tmp/jatoc.html \
          "${{ env.SITE_URL }}/jatoc.php" 2>&1) || true
        IFS='|' read -r HTTP_CODE TTFB TOTAL <<< "$(echo "$RESPONSE" | tail -1)"
        echo "http_code=$HTTP_CODE" >> $GITHUB_OUTPUT
        echo "ttfb=${TTFB}s" >> $GITHUB_OUTPUT
        if [[ "$HTTP_CODE" =~ ^2[0-9][0-9]$ ]]; then echo "status=ok"; else echo "status=fail"; fi >> $GITHUB_OUTPUT

    - name: Check NOD
      id: nod
      continue-on-error: true
      run: |
        RESPONSE=$(curl -sS -w "\n%{http_code}|%{time_starttransfer}|%{time_total}" \
          --max-time ${{ env.REQUEST_TIMEOUT }} -o /tmp/nod.html \
          "${{ env.SITE_URL }}/nod.php" 2>&1) || true
        IFS='|' read -r HTTP_CODE TTFB TOTAL <<< "$(echo "$RESPONSE" | tail -1)"
        echo "http_code=$HTTP_CODE" >> $GITHUB_OUTPUT
        echo "ttfb=${TTFB}s" >> $GITHUB_OUTPUT
        if [[ "$HTTP_CODE" =~ ^2[0-9][0-9]$ ]]; then echo "status=ok"; else echo "status=fail"; fi >> $GITHUB_OUTPUT

    - name: Check GDT
      id: gdt
      continue-on-error: true
      run: |
        RESPONSE=$(curl -sS -w "\n%{http_code}|%{time_starttransfer}|%{time_total}" \
          --max-time ${{ env.REQUEST_TIMEOUT }} -o /tmp/gdt.html \
          "${{ env.SITE_URL }}/gdt.php" 2>&1) || true
        IFS='|' read -r HTTP_CODE TTFB TOTAL <<< "$(echo "$RESPONSE" | tail -1)"
        echo "http_code=$HTTP_CODE" >> $GITHUB_OUTPUT
        echo "ttfb=${TTFB}s" >> $GITHUB_OUTPUT
        if [[ "$HTTP_CODE" =~ ^(2[0-9][0-9]|302|401|403)$ ]]; then echo "status=ok"; else echo "status=fail"; fi >> $GITHUB_OUTPUT

    - name: Check Route
      id: route
      continue-on-error: true
      run: |
        RESPONSE=$(curl -sS -w "\n%{http_code}|%{time_starttransfer}|%{time_total}" \
          --max-time ${{ env.REQUEST_TIMEOUT }} -o /tmp/route.html \
          "${{ env.SITE_URL }}/route.php" 2>&1) || true
        IFS='|' read -r HTTP_CODE TTFB TOTAL <<< "$(echo "$RESPONSE" | tail -1)"
        echo "http_code=$HTTP_CODE" >> $GITHUB_OUTPUT
        echo "ttfb=${TTFB}s" >> $GITHUB_OUTPUT
        if [[ "$HTTP_CODE" =~ ^(2[0-9][0-9]|302|401|403)$ ]]; then echo "status=ok"; else echo "status=fail"; fi >> $GITHUB_OUTPUT

    - name: Check Stats API
      id: stats_api
      continue-on-error: true
      run: |
        RESPONSE=$(curl -sS -w "\n%{http_code}|%{time_starttransfer}|%{time_total}" \
          --max-time ${{ env.REQUEST_TIMEOUT }} -H "Accept: application/json" \
          -o /tmp/stats.json "${{ env.SITE_URL }}/api/adl/stats.php" 2>&1) || true
        IFS='|' read -r HTTP_CODE TTFB TOTAL <<< "$(echo "$RESPONSE" | tail -1)"
        echo "http_code=$HTTP_CODE" >> $GITHUB_OUTPUT
        echo "ttfb=${TTFB}s" >> $GITHUB_OUTPUT
        if [[ "$HTTP_CODE" =~ ^2[0-9][0-9]$ ]] && jq -e . /tmp/stats.json > /dev/null 2>&1; then
          FLIGHTS=$(jq -r '.total // .count // .active // "?"' /tmp/stats.json 2>/dev/null)
          echo "status=ok" >> $GITHUB_OUTPUT
          echo "flights=$FLIGHTS" >> $GITHUB_OUTPUT
        else
          echo "status=fail" >> $GITHUB_OUTPUT
          echo "error=$(head -c 200 /tmp/stats.json 2>/dev/null | tr '\n' ' ')" >> $GITHUB_OUTPUT
        fi

    - name: Check Flights API
      id: flights_api
      continue-on-error: true
      run: |
        RESPONSE=$(curl -sS -w "\n%{http_code}|%{time_starttransfer}|%{time_total}" \
          --max-time ${{ env.REQUEST_TIMEOUT }} -H "Accept: application/json" \
          -o /tmp/flights.json "${{ env.SITE_URL }}/api/adl/current.php?limit=5" 2>&1) || true
        IFS='|' read -r HTTP_CODE TTFB TOTAL <<< "$(echo "$RESPONSE" | tail -1)"
        echo "http_code=$HTTP_CODE" >> $GITHUB_OUTPUT
        echo "ttfb=${TTFB}s" >> $GITHUB_OUTPUT
        if [[ "$HTTP_CODE" =~ ^2[0-9][0-9]$ ]] && jq -e . /tmp/flights.json > /dev/null 2>&1; then
          echo "status=ok" >> $GITHUB_OUTPUT
        else
          echo "status=fail" >> $GITHUB_OUTPUT
          echo "error=$(head -c 200 /tmp/flights.json 2>/dev/null | tr '\n' ' ')" >> $GITHUB_OUTPUT
        fi

    - name: Check Health API
      id: health_api
      continue-on-error: true
      env:
        HEALTH_API_KEY: ${{ secrets.MONITORING_API_KEY }}
      run: |
        if [[ -n "$HEALTH_API_KEY" ]]; then
          RESPONSE=$(curl -sS -w "\n%{http_code}|%{time_starttransfer}|%{time_total}" \
            --max-time ${{ env.REQUEST_TIMEOUT }} -H "Accept: application/json" \
            -H "X-API-Key: $HEALTH_API_KEY" \
            -o /tmp/health.json "${{ env.SITE_URL }}/api/system/health.php" 2>&1) || true
        else
          RESPONSE=$(curl -sS -w "\n%{http_code}|%{time_starttransfer}|%{time_total}" \
            --max-time ${{ env.REQUEST_TIMEOUT }} -H "Accept: application/json" \
            -o /tmp/health.json "${{ env.SITE_URL }}/api/system/health.php" 2>&1) || true
        fi
        IFS='|' read -r HTTP_CODE TTFB TOTAL <<< "$(echo "$RESPONSE" | tail -1)"
        echo "http_code=$HTTP_CODE" >> $GITHUB_OUTPUT
        echo "ttfb=${TTFB}s" >> $GITHUB_OUTPUT
        if [[ "$HTTP_CODE" =~ ^2[0-9][0-9]$ ]] && jq -e . /tmp/health.json > /dev/null 2>&1; then
          echo "status=ok" >> $GITHUB_OUTPUT
          DB=$(jq -r '.checks.database.status // .database.status // "?"' /tmp/health.json 2>/dev/null)
          MEM=$(jq -r '.checks.memory.php_memory_usage_mb // .memory.usage_mb // "?"' /tmp/health.json 2>/dev/null)
          MEM_PCT=$(jq -r '.checks.memory.system_used_pct // "?"' /tmp/health.json 2>/dev/null)
          DAEMONS_RUN=$(jq -r '.checks.daemons.running_count // "?"' /tmp/health.json 2>/dev/null)
          DAEMONS_TOT=$(jq -r '.checks.daemons.total_count // "?"' /tmp/health.json 2>/dev/null)
          DAEMON_STATUS=$(jq -r '.checks.daemons.status // "?"' /tmp/health.json 2>/dev/null)
          echo "db_status=$DB" >> $GITHUB_OUTPUT
          echo "memory=${MEM}MB" >> $GITHUB_OUTPUT
          echo "memory_pct=${MEM_PCT}%" >> $GITHUB_OUTPUT
          echo "daemons_running=$DAEMONS_RUN" >> $GITHUB_OUTPUT
          echo "daemons_total=$DAEMONS_TOT" >> $GITHUB_OUTPUT
          echo "daemons_status=$DAEMON_STATUS" >> $GITHUB_OUTPUT
        else
          echo "status=fail" >> $GITHUB_OUTPUT
        fi

    - name: Check TMI API
      id: tmi_api
      continue-on-error: true
      run: |
        RESPONSE=$(curl -sS -w "\n%{http_code}|%{time_starttransfer}|%{time_total}" \
          --max-time ${{ env.REQUEST_TIMEOUT }} -H "Accept: application/json" \
          -o /tmp/tmi.json "${{ env.SITE_URL }}/api/nod/tmi_active.php" 2>&1) || true
        IFS='|' read -r HTTP_CODE TTFB TOTAL <<< "$(echo "$RESPONSE" | tail -1)"
        echo "http_code=$HTTP_CODE" >> $GITHUB_OUTPUT
        echo "ttfb=${TTFB}s" >> $GITHUB_OUTPUT
        if [[ "$HTTP_CODE" =~ ^2[0-9][0-9]$ ]] && jq -e . /tmp/tmi.json > /dev/null 2>&1; then
          echo "status=ok" >> $GITHUB_OUTPUT
        else
          echo "status=fail" >> $GITHUB_OUTPUT
        fi

    - name: Check Stats Status API
      id: stats_status
      continue-on-error: true
      run: |
        RESPONSE=$(curl -sS -w "\n%{http_code}|%{time_starttransfer}|%{time_total}" \
          --max-time ${{ env.REQUEST_TIMEOUT }} -H "Accept: application/json" \
          -o /tmp/ss.json "${{ env.SITE_URL }}/api/stats/status.php" 2>&1) || true
        IFS='|' read -r HTTP_CODE TTFB TOTAL <<< "$(echo "$RESPONSE" | tail -1)"
        echo "http_code=$HTTP_CODE" >> $GITHUB_OUTPUT
        echo "ttfb=${TTFB}s" >> $GITHUB_OUTPUT
        if [[ "$HTTP_CODE" =~ ^2[0-9][0-9]$ ]] && jq -e . /tmp/ss.json > /dev/null 2>&1; then
          echo "status=ok" >> $GITHUB_OUTPUT
        else
          echo "status=fail" >> $GITHUB_OUTPUT
        fi

    - name: Analyze Results
      id: analyze
      run: |
        FAILURES=0
        SLOW=0

        # Count failures
        [[ "${{ steps.homepage.outputs.status }}" != "ok" ]] && FAILURES=$((FAILURES + 1)) || true
        [[ "${{ steps.jatoc.outputs.status }}" != "ok" ]] && FAILURES=$((FAILURES + 1)) || true
        [[ "${{ steps.nod.outputs.status }}" != "ok" ]] && FAILURES=$((FAILURES + 1)) || true
        [[ "${{ steps.gdt.outputs.status }}" != "ok" ]] && FAILURES=$((FAILURES + 1)) || true
        [[ "${{ steps.route.outputs.status }}" != "ok" ]] && FAILURES=$((FAILURES + 1)) || true
        [[ "${{ steps.stats_api.outputs.status }}" != "ok" ]] && FAILURES=$((FAILURES + 1)) || true
        [[ "${{ steps.flights_api.outputs.status }}" != "ok" ]] && FAILURES=$((FAILURES + 1)) || true
        [[ "${{ steps.health_api.outputs.status }}" != "ok" ]] && FAILURES=$((FAILURES + 1)) || true
        [[ "${{ steps.tmi_api.outputs.status }}" != "ok" ]] && FAILURES=$((FAILURES + 1)) || true
        [[ "${{ steps.stats_status.outputs.status }}" != "ok" ]] && FAILURES=$((FAILURES + 1)) || true

        # Check for slow responses (>2s)
        check_slow() {
          local t="${1%s}"
          if [[ -n "$t" ]] && (( $(echo "$t > 2" | bc -l 2>/dev/null || echo 0) )); then
            SLOW=$((SLOW + 1))
          fi
        }
        check_slow "${{ steps.stats_api.outputs.ttfb }}" || true
        check_slow "${{ steps.flights_api.outputs.ttfb }}" || true
        check_slow "${{ steps.health_api.outputs.ttfb }}" || true

        echo "failures=$FAILURES" >> $GITHUB_OUTPUT
        echo "slow=$SLOW" >> $GITHUB_OUTPUT

        if [[ $FAILURES -ge 5 ]]; then
          echo "severity=CRITICAL" >> $GITHUB_OUTPUT
        elif [[ $FAILURES -ge 2 ]]; then
          echo "severity=MAJOR" >> $GITHUB_OUTPUT
        elif [[ $FAILURES -ge 1 ]]; then
          echo "severity=WARNING" >> $GITHUB_OUTPUT
        elif [[ $SLOW -ge 1 ]]; then
          echo "severity=SLOW" >> $GITHUB_OUTPUT
        else
          echo "severity=HEALTHY" >> $GITHUB_OUTPUT
        fi

        echo "=== Summary ==="
        echo "Failures: $FAILURES, Slow: $SLOW"

    - name: Send Discord Alert
      if: steps.analyze.outputs.failures != '0' || steps.analyze.outputs.slow != '0' || github.event.inputs.force_alert == 'true'
      env:
        DISCORD_WEBHOOK: ${{ secrets.MONITORING_DISCORD_WEBHOOK }}
      run: |
        [[ -z "$DISCORD_WEBHOOK" ]] && echo "No webhook configured" && exit 0

        FAILURES="${{ steps.analyze.outputs.failures }}"
        SLOW="${{ steps.analyze.outputs.slow }}"
        SEV="${{ steps.analyze.outputs.severity }}"

        case "$SEV" in
          CRITICAL) COLOR=15158332 ;;
          MAJOR)    COLOR=15105570 ;;
          WARNING)  COLOR=16776960 ;;
          SLOW)     COLOR=16744192 ;;
          *)        COLOR=3066993 ;;
        esac

        icon() { [[ "$1" == "ok" ]] && echo "âœ…" || echo "âŒ"; }

        # Build JSON payload with proper escaping
        cat > /tmp/payload.json << 'ENDJSON'
        {
          "embeds": [{
            "title": "PERTI Monitor - SEVERITY_PLACEHOLDER",
            "description": "**FAILURES_PLACEHOLDER failures, SLOW_PLACEHOLDER slow**\n[perti.vatcscc.org](https://perti.vatcscc.org)",
            "color": COLOR_PLACEHOLDER,
            "fields": [
              {
                "name": "ðŸ“„ Pages",
                "value": "PAGES_PLACEHOLDER",
                "inline": true
              },
              {
                "name": "ðŸ”Œ APIs",
                "value": "APIS_PLACEHOLDER",
                "inline": true
              },
              {
                "name": "ðŸ—„ï¸ Database",
                "value": "DB_PLACEHOLDER",
                "inline": true
              },
              {
                "name": "âš™ï¸ System",
                "value": "SYSTEM_PLACEHOLDER",
                "inline": true
              },
              {
                "name": "ðŸ”— Details",
                "value": "[View Logs](LOGS_URL_PLACEHOLDER)",
                "inline": false
              }
            ],
            "footer": {"text": "External Monitor"},
            "timestamp": "TIMESTAMP_PLACEHOLDER"
          }]
        }
        ENDJSON

        # Build page status using printf for newlines
        NL=$'\n'
        PAGES="$(icon ${{ steps.homepage.outputs.status }}) Home (${{ steps.homepage.outputs.ttfb }})${NL}"
        PAGES+="$(icon ${{ steps.jatoc.outputs.status }}) JATOC (${{ steps.jatoc.outputs.ttfb }})${NL}"
        PAGES+="$(icon ${{ steps.nod.outputs.status }}) NOD (${{ steps.nod.outputs.ttfb }})${NL}"
        PAGES+="$(icon ${{ steps.gdt.outputs.status }}) GDT (${{ steps.gdt.outputs.ttfb }})${NL}"
        PAGES+="$(icon ${{ steps.route.outputs.status }}) Route (${{ steps.route.outputs.ttfb }})"

        # Build API status
        APIS="$(icon ${{ steps.stats_api.outputs.status }}) Stats (${{ steps.stats_api.outputs.ttfb }})${NL}"
        APIS+="$(icon ${{ steps.flights_api.outputs.status }}) Flights (${{ steps.flights_api.outputs.ttfb }})${NL}"
        APIS+="$(icon ${{ steps.health_api.outputs.status }}) Health (${{ steps.health_api.outputs.ttfb }})${NL}"
        APIS+="$(icon ${{ steps.tmi_api.outputs.status }}) TMI (${{ steps.tmi_api.outputs.ttfb }})${NL}"
        APIS+="$(icon ${{ steps.stats_status.outputs.status }}) Status (${{ steps.stats_status.outputs.ttfb }})"

        # Database info
        DB_STATUS="${{ steps.health_api.outputs.db_status }}"
        DB_FLIGHTS="${{ steps.stats_api.outputs.flights }}"
        DB_INFO="DB: ${DB_STATUS:-N/A}${NL}Flights: ${DB_FLIGHTS:-N/A}"

        # System info (daemons, memory)
        DAEMONS_RUN="${{ steps.health_api.outputs.daemons_running }}"
        DAEMONS_TOT="${{ steps.health_api.outputs.daemons_total }}"
        DAEMON_STATUS="${{ steps.health_api.outputs.daemons_status }}"
        MEM_PCT="${{ steps.health_api.outputs.memory_pct }}"
        if [[ "$DAEMON_STATUS" == "healthy" ]]; then
          DAEMON_ICON="âœ…"
        elif [[ "$DAEMON_STATUS" == "unhealthy" ]]; then
          DAEMON_ICON="âŒ"
        else
          DAEMON_ICON="âš ï¸"
        fi
        SYSTEM_INFO="${DAEMON_ICON} Daemons: ${DAEMONS_RUN:-?}/${DAEMONS_TOT:-?}${NL}ðŸ’¾ Memory: ${MEM_PCT:-N/A}"

        LOGS_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)

        # Replace placeholders
        sed -i "s/SEVERITY_PLACEHOLDER/$SEV/g" /tmp/payload.json
        sed -i "s/FAILURES_PLACEHOLDER/$FAILURES/g" /tmp/payload.json
        sed -i "s/SLOW_PLACEHOLDER/$SLOW/g" /tmp/payload.json
        sed -i "s/COLOR_PLACEHOLDER/$COLOR/g" /tmp/payload.json
        sed -i "s|LOGS_URL_PLACEHOLDER|$LOGS_URL|g" /tmp/payload.json
        sed -i "s/TIMESTAMP_PLACEHOLDER/$TIMESTAMP/g" /tmp/payload.json

        # Use jq to properly set the field values with newlines
        jq --arg pages "$PAGES" --arg apis "$APIS" --arg db "$DB_INFO" --arg sys "$SYSTEM_INFO" \
          '.embeds[0].fields[0].value = $pages | .embeds[0].fields[1].value = $apis | .embeds[0].fields[2].value = $db | .embeds[0].fields[3].value = $sys' \
          /tmp/payload.json > /tmp/final.json

        curl -sS -X POST -H "Content-Type: application/json" -d @/tmp/final.json "$DISCORD_WEBHOOK"
        echo "Alert sent"

    - name: Fail on Critical
      if: steps.analyze.outputs.failures >= 5
      run: exit 1
