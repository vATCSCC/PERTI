<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit AAR/ADR - {{ event.airport_icao }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>Edit Hourly AAR/ADR</h1>
            <a href="{{ url_for('index') }}" class="btn btn-back">&larr; Back to List</a>
        </header>

        <section class="event-details">
            <h2>{{ event.airport_icao }} - {{ event.event_name }}</h2>

            <div class="info-grid">
                <div class="info-item">
                    <label>Event Type</label>
                    <span>{{ event.event_type or 'N/A' }}</span>
                </div>
                <div class="info-item">
                    <label>Start (UTC)</label>
                    <span>{{ event.start_utc|datetime_format }}</span>
                </div>
                <div class="info-item">
                    <label>End (UTC)</label>
                    <span>{{ event.end_utc|datetime_format }}</span>
                </div>
                <div class="info-item">
                    <label>Duration</label>
                    <span>{{ "%.1f"|format(event.duration_hours) if event.duration_hours else 'N/A' }} hours</span>
                </div>
                <div class="info-item">
                    <label>Total Arrivals</label>
                    <span class="highlight">{{ event.total_arrivals or 0 }}</span>
                </div>
                <div class="info-item">
                    <label>Total Departures</label>
                    <span class="highlight">{{ event.total_departures or 0 }}</span>
                </div>
                <div class="info-item">
                    <label>Calculated Avg AAR</label>
                    <span class="calc-value">{{ "%.1f"|format(event.calc_avg_aar) if event.calc_avg_aar else 'N/A' }}</span>
                </div>
                <div class="info-item">
                    <label>Calculated Avg ADR</label>
                    <span class="calc-value">{{ "%.1f"|format(event.calc_avg_adr) if event.calc_avg_adr else 'N/A' }}</span>
                </div>
            </div>
        </section>

        {% if configs %}
        <section class="config-section">
            <h3>Quick Apply: Airport Configurations</h3>
            <p class="help-text">Click "Apply All" to set all hourly slots to this config's rates.</p>

            <table class="config-table">
                <thead>
                    <tr>
                        <th>Configuration</th>
                        <th>VATSIM AAR</th>
                        <th>VATSIM ADR</th>
                        <th>RW AAR</th>
                        <th>RW ADR</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for config in configs %}
                    <tr>
                        <td class="config-name">{{ config.config_name }}</td>
                        <td class="numeric">{{ config.vatsim_aar or '-' }}</td>
                        <td class="numeric">{{ config.vatsim_adr or '-' }}</td>
                        <td class="numeric">{{ config.rw_aar or '-' }}</td>
                        <td class="numeric">{{ config.rw_adr or '-' }}</td>
                        <td>
                            <button type="button" class="btn btn-use"
                                    onclick="applyConfigToAll({{ config.vatsim_aar or 'null' }}, {{ config.vatsim_adr or 'null' }}, '{{ config.config_name }}')">
                                Apply All
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </section>
        {% endif %}

        <section class="form-section">
            <h3>Hourly Rate Entry</h3>
            <p class="help-text">Enter VATSIM AAR/ADR for each hour of the event. Rates auto-save when you click Save.</p>

            <form action="{{ url_for('submit_form') }}" method="POST" class="hourly-form" id="hourlyForm">
                <input type="hidden" name="event_idx" value="{{ event.event_idx }}">
                <input type="hidden" name="airport_icao" value="{{ event.airport_icao }}">

                <div class="hourly-grid">
                    <div class="hourly-header">
                        <span class="col-hour">Hour (UTC)</span>
                        <span class="col-actual">Actual Arr</span>
                        <span class="col-actual">Actual Dep</span>
                        <span class="col-rate">VATSIM AAR</span>
                        <span class="col-rate">VATSIM ADR</span>
                    </div>

                    {% for hour in hourly_data %}
                    <div class="hourly-row">
                        <span class="col-hour hour-label">{{ hour.hour_utc }}</span>
                        <span class="col-actual">{{ hour.arrivals if hour.arrivals is not none else '-' }}</span>
                        <span class="col-actual">{{ hour.departures if hour.departures is not none else '-' }}</span>
                        <input type="hidden" name="hour_offset_{{ hour.hour_utc }}" value="{{ hour.hour_offset }}">
                        <input type="number" name="vatsim_aar_{{ hour.hour_utc }}"
                               class="col-rate rate-input aar-input"
                               value="{{ hour.vatsim_aar if hour.vatsim_aar is not none else '' }}"
                               min="0" max="200" step="1" placeholder="AAR">
                        <input type="number" name="vatsim_adr_{{ hour.hour_utc }}"
                               class="col-rate rate-input adr-input"
                               value="{{ hour.vatsim_adr if hour.vatsim_adr is not none else '' }}"
                               min="0" max="200" step="1" placeholder="ADR">
                    </div>
                    {% endfor %}
                </div>

                <div class="form-row source-row">
                    <div class="form-group">
                        <label for="aar_source">Data Source</label>
                        <select id="aar_source" name="aar_source">
                            <option value="MANUAL" {% if event.aar_source == 'MANUAL' %}selected{% endif %}>Manual Entry</option>
                            <option value="CONFIG" {% if event.aar_source == 'CONFIG' %}selected{% endif %}>From Config</option>
                            <option value="ATIS" {% if event.aar_source == 'ATIS' %}selected{% endif %}>From ATIS</option>
                        </select>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-save">Save All Hourly Rates</button>
                    <button type="button" class="btn btn-fill" onclick="fillAllWithValue()">Fill All Empty</button>
                    <a href="{{ url_for('index') }}" class="btn btn-cancel">Cancel</a>
                </div>
            </form>
        </section>

        <footer>
            <p>VATSIM ADL Event Statistics | Hourly AAR/ADR Entry Tool</p>
        </footer>
    </div>

    <script>
        const eventIdx = '{{ event.event_idx }}';
        const airportIcao = '{{ event.airport_icao }}';

        function applyConfigToAll(aar, adr, configName) {
            if (!confirm(`Apply ${configName} rates (AAR: ${aar}, ADR: ${adr}) to all hours?`)) {
                return;
            }

            // Fill all inputs on the page
            document.querySelectorAll('.aar-input').forEach(input => {
                if (aar !== null) input.value = aar;
            });
            document.querySelectorAll('.adr-input').forEach(input => {
                if (adr !== null) input.value = adr;
            });

            document.getElementById('aar_source').value = 'CONFIG';

            // Also save to database via API
            fetch('/api/apply-config', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    event_idx: eventIdx,
                    airport_icao: airportIcao,
                    vatsim_aar: aar,
                    vatsim_adr: adr
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`Applied ${configName} to ${data.message}`);
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(err => alert('Error: ' + err));
        }

        function fillAllWithValue() {
            const aar = prompt('Enter AAR value for all empty slots:', '');
            if (aar === null) return;

            const adr = prompt('Enter ADR value for all empty slots:', aar);
            if (adr === null) return;

            document.querySelectorAll('.aar-input').forEach(input => {
                if (!input.value && aar) input.value = aar;
            });
            document.querySelectorAll('.adr-input').forEach(input => {
                if (!input.value && adr) input.value = adr;
            });
        }
    </script>
</body>
</html>
